<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLOCK-DARK</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
            color: #333333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            font-weight: bold;
            color: #000;
        }

        .form-section {
            background-color: #f8f8f8;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-section h2 {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .form-group input,
        .form-group select {
            width: 48%;
            padding: 10px;
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid #cccccc;
        }

        .form-group-full {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .form-group-full input[type="range"] {
            width: 100%;
        }

        .submit-btn {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .submit-btn button {
            padding: 10px 30px;
            font-size: 1.2em;
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .submit-btn button:hover {
            background-color: #333;
        }

        .wallet-overview {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .wallet-overview h3 {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .wallet-overview .overview-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .overview-item span {
            font-size: 1.1em;
        }

        .graph-section {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 10px;
        }

        .graph-section h3 {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .graph-placeholder {
            height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #eaeaea;
            border-radius: 10px;
            font-size: 1.2em;
            color: #666666;
        }

        .graph-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .graph {
            width: 48%;
            height: 500px;
            background-color: #eaeaea;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        svg {
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>

<div class="container">
    <h1>BLOCK-DARK</h1>

    <!-- 조사 설정 -->
    <div class="form-section">
        <h2>조사 설정</h2>
        <form id="survey-form">
            <div class="form-group">
                <input type="text" id="bitcoin-address" placeholder="비트코인 주소 입력" required>
                <input type="date" id="start-date" placeholder="시작 날짜">
            </div>

            <div class="form-group">
                <input type="number" id="min-amount" placeholder="최소 트랜잭션 금액 (사토시)" required>
                <input type="date" id="end-date" placeholder="종료 날짜">
            </div>

            <div class="form-group">
                <input type="range" id="trace-depth" min="1" max="5" value="2">
                <select id="transaction-filter">
                    <option value="전체">전체</option>
                    <option value="보낸 트랜잭션">보낸 트랜잭션</option>
                    <option value="받은 트랜잭션">받은 트랜잭션</option>
                </select>
            </div>

            <div class="submit-btn">
                <button type="submit">조사 시작</button>
            </div>
        </form>
    </div>

    <div class="wallet-overview" id="wallet-overview">
        <h3>(비트코인주소)님 지갑개요</h3>
        <div class="overview-item">
            <span>받은 총액</span>
            <span id="total-received">₿ 0 사토시</span>
        </div>
        <div class="overview-item">
            <span>보낸 총액</span>
            <span id="total-sent">₿ 0 사토시</span>
        </div>
        <div class="overview-item">
            <span>최초 트랜잭션 날짜</span>
            <span id="first-transaction">-</span>
        </div>
        <div class="overview-item">
            <span>마지막 트랜잭션 날짜</span>
            <span id="last-transaction">-</span>
        </div>
        <div class="overview-item">
            <span>최근 24시간 받은 금액</span>
            <span id="received-24h">₿ 0 사토시</span>
        </div>
        <div class="overview-item">
            <span>최근 24시간 보낸 금액</span>
            <span id="sent-24h">₿ 0 사토시</span>
        </div>
        <div class="overview-item">
            <span>잔액</span>
            <span id="balance">₿ 0 사토시</span>
        </div>
    </div>

    <div class="graph-section">
        <h3>트랜잭션 그래프</h3>
        <div class="graph-container">
            <div class="graph" id="graph1"></div>
            <div class="graph" id="graph2"></div>
        </div>
    </div>

</div>

<script>
    async function getTransactionHistory(address) {
        try {
            const response = await fetch(`https://blockchain.info/rawaddr/${address}`);
            if (!response.ok) {
                throw new Error('API 호출 실패');
            }
            return await response.json();
        } catch (error) {
            console.error('트랜잭션 데이터를 가져오는 중 오류 발생:', error);
            return null;
        }
    }

    document.getElementById('survey-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const bitcoinAddress = document.getElementById('bitcoin-address').value;
        const transactions = await getTransactionHistory(bitcoinAddress);

        if (transactions) {
            document.getElementById('wallet-overview').querySelector('h3').innerText = `${bitcoinAddress}님 지갑개요`;
            document.getElementById('total-received').innerText = `₿ ${transactions.total_received} 사토시`;
            document.getElementById('total-sent').innerText = `₿ ${transactions.total_sent} 사토시`;
            document.getElementById('first-transaction').innerText = new Date(transactions.txs[0].time * 1000).toLocaleString();
            document.getElementById('last-transaction').innerText = new Date(transactions.txs[transactions.txs.length - 1].time * 1000).toLocaleString();
            document.getElementById('received-24h').innerText = `₿ ${transactions.total_received} 사토시`;
            document.getElementById('sent-24h').innerText = `₿ ${transactions.total_sent} 사토시`;
            document.getElementById('balance').innerText = `₿ ${transactions.final_balance} 사토시`;

            drawNetworkGraph(transactions, "#graph1");
            drawTransactionTree(transactions, "#graph2");
        }
    });

    function drawNetworkGraph(transactions, selector) {
        const svg = d3.select(selector).append("svg").attr("width", 500).attr("height", 500);
        const nodes = [], links = [];

        transactions.txs.forEach(tx => {
            nodes.push({ id: tx.hash });
            tx.out.forEach(output => {
                if (output.addr) {
                    nodes.push({ id: output.addr });
                    links.push({ source: tx.hash, target: output.addr, value: output.value });
                }
            });
        });

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(250, 250));

        const link = svg.append("g")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("stroke-width", d => Math.sqrt(d.value));

        const node = svg.append("g")
            .selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("r", 5)
            .attr("fill", "blue");

        simulation.nodes(nodes).on("tick", () => {
            link.attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("cx", d => d.x)
                .attr("cy", d => d.y);
        });
    }

    function drawTransactionTree(transactions, selector) {
        const svg = d3.select(selector).append("svg").attr("width", 500).attr("height", 500);
        const treeData = {
            name: "Transactions",
            children: transactions.txs.map(tx => ({
                name: tx.hash,
                children: tx.out.map(output => ({
                    name: output.addr || "Unknown",
                    value: output.value
                }))
            }))
        };

        const root = d3.hierarchy(treeData);
        const treeLayout = d3.tree().size([400, 400]);
        treeLayout(root);

        svg.selectAll("line")
            .data(root.links())
            .enter().append("line")
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y)
            .attr("stroke", "black");

        svg.selectAll("circle")
            .data(root.descendants())
            .enter().append("circle")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", 5)
            .attr("fill", "blue");

        svg.selectAll("text")
            .data(root.descendants())
            .enter().append("text")
            .attr("x", d => d.x + 5)
            .attr("y", d => d.y + 5)
            .text(d => d.data.name);
    }
</script>

</body>
</html>
